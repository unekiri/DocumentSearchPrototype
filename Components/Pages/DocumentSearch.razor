@page "/document-search"
@rendermode InteractiveServer

@using System.Text
@using System.Text.Json
@using System.Text.Json.Serialization
@using Azure.Storage.Blobs
@using Azure.Storage.Sas

@inject IHttpClientFactory HttpClientFactory
@inject IConfiguration Configuration
@inject IJSRuntime JSRuntime
@inject BlobServiceClient BlobServiceClient
@inject ILogger<DocumentSearch> Logger

<PageTitle>金入設計書の検索</PageTitle>

<h1>金入設計書の検索</h1>

<p>検索ワードを入力してください。</p>

<div class="input-group mb-3">
    <input type="text" class="form-control" @bind="searchTerm" @onkeyup="HandleKeyUp"/>
    <button class="btn btn-primary" @onclick="Search" disabled="@isLoading">
        @if (isLoading)
        {
            <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
            <span>Searching...</span>
        }
        else
        {
            <span class="bi bi-search"></span>
            <span>Search</span>
        }
    </button>
</div>

@if (searchResults != null && searchResults.Any())
{
    <h4>検索結果</h4>
    <div class="list-group">
        @foreach (var result in searchResults)
        {
            <div class="list-group-item list-group-item-action" @onclick="() => ViewDocument(result.FileName)" style="cursor: pointer;" title="Click to view document">
                <div class="d-flex w-100 justify-content-between">
                    <h5 class="mb-1">@result.FileName</h5>
                </div>
                <p class="mb-1">
                    最も関連性の高いページ <strong>@result.TopPageNumber</strong>.
                </p>
                <p class="mb-1">
                    関連性のあるページ @string.Join(", ", result.PageNumbers)
                </p>
            </div>
        }
    </div>
}
else if (isLoading)
{
    <p><em>Searching...</em></p>
}
else if (searchAttempted && (searchResults == null || !searchResults.Any()))
{
    <div class="alert alert-warning" role="alert">
        No results found for "@searchedTerm".
    </div>
}


@code {
    private string? searchTerm;
    private string? searchedTerm;
    private bool isLoading = false;
    private bool searchAttempted = false;
    private List<SearchResult>? searchResults;

    private async Task ViewDocument(string fileName)
    {
        try
        {
            var containerName = Configuration["AzureStorage:ContainerName"];
            if (string.IsNullOrWhiteSpace(containerName))
            {
                Logger.LogError("AzureStorage:ContainerName is not configured.");
                await JSRuntime.InvokeVoidAsync("alert", "Storage container is not configured.");
                return;
            }

            var containerClient = BlobServiceClient.GetBlobContainerClient(containerName);
            var blobClient = containerClient.GetBlobClient(fileName);

            if (await blobClient.ExistsAsync())
            {
                var sasBuilder = new BlobSasBuilder
                {
                    BlobContainerName = containerName,
                    BlobName = fileName,
                    Resource = "b", // "b" for blob
                    ExpiresOn = DateTimeOffset.UtcNow.AddMinutes(15)
                };

                sasBuilder.SetPermissions(BlobSasPermissions.Read);

                Uri sasUri = blobClient.GenerateSasUri(sasBuilder);
                Logger.LogInformation("Generated SAS URL for blob {BlobName} in container {ContainerName}.", fileName, containerName);
                await JSRuntime.InvokeVoidAsync("open", sasUri.ToString(), "_blank");
            }
            else
            {
                Logger.LogWarning("Blob not found. Container={ContainerName}, BlobName={BlobName}", containerName, fileName);
                await JSRuntime.InvokeVoidAsync("alert", $"File '{fileName}' not found in storage.");
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to generate SAS URL. BlobName={BlobName}", fileName);
            await JSRuntime.InvokeVoidAsync("alert", $"Error generating file URL: {ex.Message}");
        }
    }

    private async Task Search()
    {
        if (string.IsNullOrWhiteSpace(searchTerm))
        {
            return;
        }

        isLoading = true;
        searchAttempted = true;
        searchedTerm = searchTerm;
        searchResults = null;

        var httpClient = HttpClientFactory.CreateClient("AzureSearchClient");
        Logger.LogInformation("Search requested. TermLength={TermLength}", searchTerm.Length);
        Logger.LogDebug("Search term={SearchTerm}", searchTerm);

        var requestBody = new
        {
            search = searchTerm,
            count = true,
            searchMode = "any"
        };

        var content = new StringContent(JsonSerializer.Serialize(requestBody), Encoding.UTF8, "application/json");

        try
        {
            var indexName = Configuration["AzureSearch:IndexName"];
            if (string.IsNullOrEmpty(indexName))
            {
                Logger.LogError("AzureSearch:IndexName is not configured.");
                throw new InvalidOperationException("Azure Search IndexName is not configured.");
            }

            var requestUrl = $"indexes/{indexName}/docs/search?api-version=2024-05-01-preview";
            var response = await httpClient.PostAsync(requestUrl, content);
            if (!response.IsSuccessStatusCode)
            {
                var errorBody = await response.Content.ReadAsStringAsync();
                var truncated = errorBody.Length > 2048 ? errorBody[..2048] : errorBody;
                Logger.LogWarning(
                    "Azure Search request failed. StatusCode={StatusCode}, Reason={ReasonPhrase}, Url={Url}, Body={Body}",
                    (int)response.StatusCode,
                    response.ReasonPhrase,
                    requestUrl,
                    truncated);
                searchResults = null;
                return;
            }

            var responseBody = await response.Content.ReadFromJsonAsync<SearchApiResponse>();

            searchResults = responseBody?.Value?
                .GroupBy(r => r.FileName)
                .Select(g =>
                {
                    var top = g.OrderByDescending(r => r.Score).First();
                    var pages = g.Select(r => r.PageNumber).Distinct().OrderBy(p => p).ToList();
                    return new SearchResult(g.Key, top.PageNumber, top.Score, pages);
                })
                .OrderByDescending(r => r.TopScore)
                .ToList();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Search failed. TermLength={TermLength}", searchTerm.Length);
            searchResults = null;
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task HandleKeyUp(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            await Search();
        }
    }

    // C# record types to deserialize the JSON response
    public record SearchResult(string FileName, int TopPageNumber, double TopScore, List<int> PageNumbers);

    public class SearchApiResponse
    {
        [JsonPropertyName("@odata.count")]
        public int? Count { get; set; }

        [JsonPropertyName("value")]
        public List<ApiResultValue>? Value { get; set; }
    }

    public class ApiResultValue
    {
        [JsonPropertyName("@search.score")]
        public double Score { get; set; }

        [JsonPropertyName("metadata_storage_name")]
        public string FileName { get; set; } = string.Empty;

        [JsonPropertyName("pageNumber")]
        public int PageNumber { get; set; }
    }
}
